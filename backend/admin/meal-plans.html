<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Danh s√°ch M√≥n ƒÉn - ViPT Admin</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="main-container">
        <div id="sidebar-container"></div>
        <div id="header-container"></div>
        <div class="content-area">
            <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                <div class="spinner"></div>
            </div>
            <div id="content" class="tab-content"></div>
        </div>
    </div>
    <div id="modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Th√™m m·ªõi</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    <script type="module">
        import { renderNavigation, renderHeader } from './components/nav.js';
        import { checkAuth, setupHeaderListeners, showLoading, hideLoading, showToast } from './shared.js';
        import {
          collectionsAPI,
          uploadAPI,
          mealsAPI,
          planMealAPI,
        } from "./api.js";
        
        document.getElementById('sidebar-container').innerHTML = renderNavigation('meal-plans');
        document.getElementById('header-container').innerHTML = renderHeader();
        document.getElementById('pageTitle').textContent = 'Qu·∫£n l√Ω Danh s√°ch M√≥n ƒÉn';
        
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('modalBody').innerHTML = '';
        });
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('modal')) {
                document.getElementById('modal').style.display = 'none';
                document.getElementById('modalBody').innerHTML = '';
            }
        });

        checkAuth().then(authenticated => {
            if (authenticated) {
                setupHeaderListeners();
                loadData();
            }
        });

        async function loadData() {
          showLoading();
          try {
            // Load PlanMealCollections v·ªõi planID = 0 (default plan)
            const response = await planMealAPI.getCollections(0);
            const plans = response.data || [];

            // Load meals cho m·ªói collection
            for (let plan of plans) {
              if (plan._id) {
                try {
                  const mealsResponse = await planMealAPI.getMeals(plan._id);
                  plan.meals = mealsResponse.data || [];
                  // Map meals ƒë·ªÉ t∆∞∆°ng th√≠ch v·ªõi code hi·ªán t·∫°i
                  plan.mealIDs = plan.meals.map((m) => m.mealID);
                } catch (error) {
                  console.error(
                    `Error loading meals for collection ${plan._id}:`,
                    error
                  );
                  plan.meals = [];
                  plan.mealIDs = [];
                }
              }
            }

            renderTable(plans);
          } catch (error) {
            document.getElementById(
              "content"
            ).innerHTML = `<div class="empty-state">L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}</div>`;
          } finally {
            hideLoading();
          }
        }

        function renderTable(plans) {
            if (plans.length === 0) {
                document.getElementById('content').innerHTML = `
                    <div class="data-table">
                        <div class="table-header">
                            <h2>Qu·∫£n l√Ω Danh s√°ch M√≥n ƒÉn</h2>
                            <button class="btn-add" onclick="openForm()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                                Th√™m m·ªõi
                            </button>
                        </div>
                        <div class="empty-state">
                            <p>Ch∆∞a c√≥ danh s√°ch n√†o</p>
                        </div>
                    </div>
                `;
                return;
            }

            const rows = plans.map((plan) => {
              // Format date n·∫øu c√≥
              let dateDisplay = "";
              if (plan.date) {
                const date = new Date(plan.date);
                dateDisplay = date.toLocaleDateString("vi-VN", {
                  day: "2-digit",
                  month: "2-digit",
                  year: "numeric",
                });
              }

              // X·ª≠ l√Ω danh s√°ch m√≥n ƒÉn
              let mealsHTML = "";
              const mealCount = plan.meals ? plan.meals.length : 0;

              if (mealCount > 0 && plan.meals) {
                // meals c√≥ th·ªÉ l√† array of objects (populated) ho·∫∑c array of IDs
                // Filter out null/undefined mealIDs
                const validMeals = plan.meals.filter((meal) => meal && meal.mealID);
                const mealList = validMeals.map((meal) => {
                  if (typeof meal.mealID === "object" && meal.mealID && meal.mealID.name) {
                    // ƒê√£ ƒë∆∞·ª£c populate, c√≥ th√¥ng tin chi ti·∫øt
                    return {
                      name: meal.mealID.name,
                      asset: meal.mealID.asset || null,
                    };
                  }
                  // Ch·ªâ c√≥ ID, kh√¥ng c√≥ th√¥ng tin chi ti·∫øt
                  return {
                    name: `M√≥n ƒÉn ${meal.mealID}`,
                    asset: null,
                  };
                });

                mealsHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 6px;">
                  ${mealList
                    .map(
                      (meal) => `
                    <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: linear-gradient(135deg, #FFE0B2 0%, #FFCC80 100%); border-radius: 16px; font-size: 12px; font-weight: 500; color: #E65100; box-shadow: 0 2px 4px rgba(230, 81, 0, 0.1);">
                      ${
                        meal.asset
                          ? `<img src="${meal.asset}" alt="${meal.name}" style="width: 20px; height: 20px; border-radius: 4px; object-fit: cover;">`
                          : `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                            </svg>`
                      }
                      <span>${meal.name}</span>
                    </span>
                  `
                    )
                    .join("")}
                </div>
                <div style="font-size: 12px; color: #666; font-weight: 500;">
                  üçΩÔ∏è T·ªïng: <strong>${mealList.length}</strong> m√≥n ƒÉn | T·ª∑ l·ªá: <strong>${
                  plan.mealRatio || 1.0
                }</strong>
                </div>
              `;
              } else {
                mealsHTML = `
                <div style="display: flex; align-items: center; gap: 8px; color: #999; font-size: 14px; padding: 8px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                  </svg>
                  <span>Ch∆∞a c√≥ m√≥n ƒÉn n√†o</span>
                </div>
              `;
              }

              return `
                <tr>
                    <td><strong>${
                      dateDisplay || "Ch∆∞a c√≥ ng√†y"
                    }</strong></td>
                    <td style="max-width: 400px;">
                      ${mealsHTML}
                    </td>
                    <td>
                        <button class="btn-edit" onclick="openForm('${
                          plan._id
                        }')">S·ª≠a</button>
                        <button class="btn-delete" onclick="deleteItem('${
                          plan._id
                        }')">X√≥a</button>
                    </td>
                </tr>
            `;
            }).join("");

            document.getElementById('content').innerHTML = `
                <div class="data-table">
                    <div class="table-header">
                        <h2>Qu·∫£n l√Ω Danh s√°ch M√≥n ƒÉn</h2>
                        <button class="btn-add" onclick="openForm()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            Th√™m m·ªõi
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ng√†y</th>
                                    <th>Danh s√°ch m√≥n ƒÉn</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        window.openForm = async function (id = null) {
          try {
            let plan = null;
            if (id) {
              const response = await planMealAPI.getCollectionById(id);
              plan = response.data;

              // Load meals v√† setting
              if (plan._id) {
                try {
                  const mealsResponse = await planMealAPI.getMeals(plan._id);
                  plan.meals = (mealsResponse.data || []).filter((m) => m && m.mealID);
                  plan.mealIDs = plan.meals.map((m) => {
                    // Handle both ObjectId and string for mealID
                    if (typeof m.mealID === "object" && m.mealID && m.mealID._id) {
                      return m.mealID._id.toString();
                    }
                    return m.mealID?.toString() || "";
                  }).filter((id) => id); // Filter out empty strings
                } catch (error) {
                  console.error("Error loading meals:", error);
                  plan.meals = [];
                  plan.mealIDs = [];
                }
              }
            }

            // Parse date n·∫øu c√≥
            let selectedDate = null;
            if (plan?.date) {
              selectedDate = new Date(plan.date);
            } else {
              selectedDate = new Date();
            }

            // Format date cho input
            const dateInputValue = selectedDate.toISOString().split("T")[0];

            // Load danh s√°ch meals ƒë·ªÉ hi·ªÉn th·ªã
            const mealsResponse = await mealsAPI.getAll();
            const meals = mealsResponse.data || [];
            // X·ª≠ l√Ω selected meal IDs
            const selectedMealIds = plan?.mealIDs || [];

            // T·∫°o HTML cho selected meals (chips)
            const selectedMealsHTML = selectedMealIds
              .map((id) => {
                const meal = meals.find((m) => m._id?.toString() === id);
                if (!meal) return "";
                return `
                <span class="chip meal-chip" data-id="${id}" style="display: inline-flex; align-items: center; padding: 6px 12px; margin: 4px; background: #FFE0B2; border-radius: 16px; font-size: 14px; font-weight: 600;">
                  ${meal.name}
                  <span class="chip-close" style="margin-left: 8px; cursor: pointer; font-weight: bold;">&times;</span>
                </span>
              `;
              })
              .join("");

            // T·∫°o dropdown options cho meals (ch·ªâ nh·ªØng c√°i ch∆∞a ƒë∆∞·ª£c ch·ªçn)
            const availableMeals = meals.filter(
              (m) => !selectedMealIds.includes(m._id?.toString() || "")
            );
            const mealDropdownOptions = availableMeals
              .map((m) => `<option value="${m._id}">${m.name}</option>`)
              .join("");

            document.getElementById("modalTitle").textContent = id
              ? "S·ª≠a danh s√°ch m√≥n ƒÉn"
              : "Th√™m danh s√°ch m√≥n ƒÉn";
            document.getElementById("modalBody").innerHTML = `
                    <form id="planForm" class="form-grid">
                        <div class="form-group">
                            <label for="planDate">Ng√†y *</label>
                            <input type="date" id="planDate" value="${dateInputValue}" required style="width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 12px; font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label for="planMealRatio">T·ª∑ l·ªá m√≥n ƒÉn *</label>
                            <input type="number" id="planMealRatio" value="${
                              plan?.mealRatio || 1.0
                            }" min="0.1" step="0.1" required style="width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 12px; font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <div style="font-weight: 500; margin-bottom: 8px; color: var(--text-primary); display: flex; align-items: center;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                </svg>
                                M√≥n ƒÉn
                            </div>
                            <div style="border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: var(--surface);">
                                <div id="selectedMeals" style="min-height: 40px; margin-bottom: 12px; display: flex; flex-wrap: wrap; align-items: flex-start;">
                                    ${
                                      selectedMealsHTML ||
                                      '<span style="color: #999; font-size: 14px;">Ch∆∞a c√≥ m√≥n ƒÉn n√†o ƒë∆∞·ª£c ch·ªçn</span>'
                                    }
                                </div>
                                ${
                                  meals.length === 0
                                    ? '<p style="color: #999; margin: 0; font-size: 14px;">Ch∆∞a c√≥ m√≥n ƒÉn n√†o. Vui l√≤ng t·∫°o m√≥n ƒÉn tr∆∞·ªõc.</p>'
                                    : `
                                      <select id="mealDropdown" style="width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 12px; font-size: 14px; background: var(--surface); cursor: pointer;">
                                        <option value="">-- Ch·ªçn m√≥n ƒÉn ƒë·ªÉ th√™m --</option>
                                        ${mealDropdownOptions}
                                      </select>
                                    `
                                }
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn-secondary" onclick="document.getElementById('modal').style.display='none'">H·ªßy</button>
                            <button type="submit" class="btn-primary">L∆∞u</button>
                        </div>
                    </form>
                `;
            // L∆∞u danh s√°ch meals ƒë·ªÉ s·ª≠ d·ª•ng sau
            let currentSelectedMealIds = [...selectedMealIds];

            // X·ª≠ l√Ω dropdown v√† chips cho meals
            const mealDropdown = document.getElementById("mealDropdown");
            const selectedMealsContainer = document.getElementById("selectedMeals");

            function updateMealChips() {
              if (!selectedMealsContainer) return;
              const chipsHTML = currentSelectedMealIds
                .map((id) => {
                  const meal = meals.find((m) => m._id?.toString() === id);
                  if (!meal) return "";
                  return `
                  <span class="chip meal-chip" data-id="${id}" style="display: inline-flex; align-items: center; padding: 6px 12px; margin: 4px; background: #FFE0B2; border-radius: 16px; font-size: 14px; font-weight: 600;">
                    ${meal.name}
                    <span class="chip-close" style="margin-left: 8px; cursor: pointer; font-weight: bold;">&times;</span>
                  </span>
                `;
                })
                .join("");
              selectedMealsContainer.innerHTML =
                chipsHTML ||
                '<span style="color: #999; font-size: 14px;">Ch∆∞a c√≥ m√≥n ƒÉn n√†o ƒë∆∞·ª£c ch·ªçn</span>';
            }

            function updateMealDropdown() {
              if (!mealDropdown) return;
              const availableMeals = meals.filter(
                (m) => !currentSelectedMealIds.includes(m._id?.toString() || "")
              );

              if (availableMeals.length === 0 && meals.length > 0) {
                mealDropdown.style.display = "none";
                let message = mealDropdown.parentElement.querySelector(
                  ".dropdown-message"
                );
                if (!message) {
                  message = document.createElement("p");
                  message.className = "dropdown-message";
                  message.style.cssText =
                    "color: #999; margin: 0; font-size: 14px;";
                  message.textContent = "ƒê√£ ch·ªçn t·∫•t c·∫£ m√≥n ƒÉn.";
                  mealDropdown.parentElement.appendChild(message);
                }
              } else {
                mealDropdown.style.display = "block";
                const message = mealDropdown.parentElement.querySelector(
                  ".dropdown-message"
                );
                if (message) message.remove();
                mealDropdown.innerHTML =
                  '<option value="">-- Ch·ªçn m√≥n ƒÉn ƒë·ªÉ th√™m --</option>' +
                  availableMeals
                    .map((m) => `<option value="${m._id}">${m.name}</option>`)
                    .join("");
              }
            }

            if (mealDropdown) {
              mealDropdown.addEventListener("change", (e) => {
                const selectedId = e.target.value;
                if (
                  selectedId &&
                  !currentSelectedMealIds.includes(selectedId)
                ) {
                  currentSelectedMealIds.push(selectedId);
                  updateMealChips();
                  updateMealDropdown();
                }
                e.target.value = ""; // Reset dropdown
              });
            }

            // X·ª≠ l√Ω x√≥a meal chip
            if (selectedMealsContainer) {
              selectedMealsContainer.addEventListener("click", (e) => {
                if (
                  e.target.classList.contains("chip-close") ||
                  e.target.closest(".chip-close")
                ) {
                  const chip = e.target.closest(".meal-chip");
                  if (chip) {
                    const id = chip.dataset.id;
                    currentSelectedMealIds = currentSelectedMealIds.filter(
                      (mid) => mid !== id
                    );
                    updateMealChips();
                    updateMealDropdown();
                  }
                }
              });
            }

            // Kh·ªüi t·∫°o dropdown
            updateMealDropdown();

            const planForm = document.getElementById("planForm");
            if (!planForm) {
              console.error("Kh√¥ng t√¨m th·∫•y element planForm");
              showToast("‚ùå L·ªói: Kh√¥ng th·ªÉ t·∫£i form", "error");
              return;
            }

            planForm.addEventListener("submit", async (e) => {
              e.preventDefault();

              // L·∫•y date t·ª´ input
              const dateInput = document.getElementById("planDate").value;
              if (!dateInput) {
                showToast("‚ùå Vui l√≤ng ch·ªçn ng√†y", "error");
                return;
              }

              const selectedDate = new Date(dateInput);

              // L·∫•y mealRatio
              const mealRatio =
                parseFloat(document.getElementById("planMealRatio").value) ||
                1.0;

              if (currentSelectedMealIds.length === 0) {
                showToast("‚ùå Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt m√≥n ƒÉn", "error");
                return;
              }

              const data = {
                date: selectedDate.toISOString(),
                planID: 0, // Default plan
                mealRatio: mealRatio,
                mealIDs: currentSelectedMealIds.filter((id) => id),
              };

              try {
                showLoading();
                if (id) {
                  await planMealAPI.updateCollection(id, data);
                  showToast("‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!", "success");
                } else {
                  await planMealAPI.createCollection(data);
                  showToast("‚úÖ Th√™m m·ªõi th√†nh c√¥ng!", "success");
                }
                document.getElementById("modal").style.display = "none";
                loadData();
              } catch (error) {
                showToast(`‚ùå ${error.message}`, "error");
              } finally {
                hideLoading();
              }
            });
                
                document.getElementById('modal').style.display = 'flex';
            } catch (error) {
                showToast(`‚ùå ${error.message}`, 'error');
            }
        };

        window.deleteItem = async function (id) {
          if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a danh s√°ch m√≥n ƒÉn n√†y?")) return;

          try {
            showLoading();
            await planMealAPI.deleteCollection(id);
            showToast("‚úÖ X√≥a th√†nh c√¥ng!", "success");
            loadData();
          } catch (error) {
            showToast(`‚ùå ${error.message}`, "error");
          } finally {
            hideLoading();
          }
        };
    </script>
</body>
</html>

