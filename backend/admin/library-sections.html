<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Th∆∞ vi·ªán - ViPT Admin</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="main-container">
        <div id="sidebar-container"></div>
        <div id="header-container"></div>
        <div class="content-area">
            <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                <div class="spinner"></div>
            </div>
            <div id="content" class="tab-content"></div>
        </div>
    </div>
    <div id="modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Th√™m m·ªõi</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    <script type="module">
        import { renderNavigation, renderHeader } from './components/nav.js';
        import { checkAuth, setupHeaderListeners, showLoading, hideLoading, showToast } from './shared.js';
        import { librarySectionsAPI, uploadAPI } from './api.js';
        
        document.getElementById('sidebar-container').innerHTML = renderNavigation('library-sections');
        document.getElementById('header-container').innerHTML = renderHeader();
        document.getElementById('pageTitle').textContent = 'Qu·∫£n l√Ω Th∆∞ vi·ªán';
        
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('modalBody').innerHTML = '';
        });
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('modal')) {
                document.getElementById('modal').style.display = 'none';
                document.getElementById('modalBody').innerHTML = '';
            }
        });

        checkAuth().then(authenticated => {
            if (authenticated) {
                setupHeaderListeners();
                loadData();
            }
        });

        async function loadData() {
            showLoading();
            try {
                const response = await librarySectionsAPI.getAll();
                const sections = response.data || [];
                renderTable(sections);
            } catch (error) {
                document.getElementById('content').innerHTML = `<div class="empty-state">L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}</div>`;
            } finally {
                hideLoading();
            }
        }

        function renderTable(sections) {
            if (sections.length === 0) {
                document.getElementById('content').innerHTML = `
                    <div class="data-table">
                        <div class="table-header">
                            <h2>Qu·∫£n l√Ω Th∆∞ vi·ªán</h2>
                            <button class="btn-add" onclick="openForm()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                                Th√™m m·ªõi
                            </button>
                        </div>
                        <div class="empty-state">
                            <p>Ch∆∞a c√≥ m·ª•c n√†o</p>
                        </div>
                    </div>
                `;
                return;
            }

            const rows = sections.map(section => `
                <tr>
                    <td>
                        ${section.asset ? `<img src="${section.asset}" alt="${section.title}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;">` : '<div style="width: 50px; height: 50px; background: #f0f0f0; border-radius: 8px;"></div>'}
                    </td>
                    <td><strong>${section.title}</strong></td>
                    <td>${section.route || ''}</td>
                    <td>${section.order || 0}</td>
                    <td>${section.isActive ? 'C√≥' : 'Kh√¥ng'}</td>
                    <td>
                        <button class="btn-edit" onclick="openForm('${section._id}')">S·ª≠a</button>
                        <button class="btn-delete" onclick="deleteItem('${section._id}')">X√≥a</button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('content').innerHTML = `
                <div class="data-table">
                    <div class="table-header">
                        <h2>Qu·∫£n l√Ω Th∆∞ vi·ªán</h2>
                        <button class="btn-add" onclick="openForm()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            Th√™m m·ªõi
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>·∫¢nh</th>
                                    <th>Ti√™u ƒë·ªÅ</th>
                                    <th>Route</th>
                                    <th>Th·ª© t·ª±</th>
                                    <th>Ho·∫°t ƒë·ªông</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        window.openForm = async function(id = null) {
            try {
                let section = null;
                if (id) {
                    const response = await librarySectionsAPI.getById(id);
                    section = response.data;
                }
                
                document.getElementById('modalTitle').textContent = id ? 'S·ª≠a m·ª•c th∆∞ vi·ªán' : 'Th√™m m·ª•c th∆∞ vi·ªán';
                document.getElementById('modalBody').innerHTML = `
                    <form id="sectionForm" class="form-grid">
                        <div class="form-group">
                            <label for="sectionTitle">Ti√™u ƒë·ªÅ *</label>
                            <input type="text" id="sectionTitle" value="${section?.title || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="sectionDescription">M√¥ t·∫£</label>
                            <textarea id="sectionDescription" rows="3">${section?.description || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="sectionRoute">M√†n h√¨nh ƒëi·ªÅu h∆∞·ªõng *</label>
                            <select id="sectionRoute" required style="width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 12px; font-size: 14px; background: var(--surface);">
                                <option value="">-- Ch·ªçn m√†n h√¨nh ƒëi·ªÅu h∆∞·ªõng --</option>
                                <option value="/workoutCategory" ${section?.route === '/workoutCategory' ? 'selected' : ''}>üìã Danh m·ª•c b√†i t·∫≠p</option>
                                <option value="/workoutCollectionCategory" ${section?.route === '/workoutCollectionCategory' ? 'selected' : ''}>üìÇ Danh m·ª•c b·ªô luy·ªán t·∫≠p</option>
                                <option value="/dishCategory" ${section?.route === '/dishCategory' ? 'selected' : ''}>üçΩÔ∏è Danh m·ª•c m√≥n ƒÉn</option>
                            </select>
                            <small style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
                                Ch·ªçn m√†n h√¨nh s·∫Ω m·ªü khi ng∆∞·ªùi d√πng nh·∫•n v√†o m·ª•c n√†y
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="sectionAssetFile">URL ·∫£nh</label>
                            <input type="file" id="sectionAssetFile" accept="image/*">
                            <div id="sectionAssetPreview" style="margin-top: 10px;">
                                ${section?.asset ? `<img src="${section.asset}" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;">` : ''}
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="sectionOrder">Th·ª© t·ª±</label>
                            <input type="number" id="sectionOrder" value="${section?.order || 0}">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="sectionIsActive" ${section?.isActive !== false ? 'checked' : ''}>
                                Ho·∫°t ƒë·ªông
                            </label>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn-secondary" onclick="document.getElementById('modal').style.display='none'">H·ªßy</button>
                            <button type="submit" class="btn-primary">L∆∞u</button>
                        </div>
                    </form>
                `;
                
                // Preview image khi ch·ªçn file
                const assetFileInput = document.getElementById('sectionAssetFile');
                const assetPreview = document.getElementById('sectionAssetPreview');
                let currentAsset = section?.asset || '';
                
                assetFileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            assetPreview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
                        };
                        reader.readAsDataURL(file);
                        
                        try {
                            showLoading();
                            const response = await uploadAPI.uploadImage(file);
                            currentAsset = response.data.url;
                            showToast('‚úÖ Upload ·∫£nh th√†nh c√¥ng!', 'success');
                        } catch (error) {
                            showToast(`‚ùå L·ªói upload ·∫£nh: ${error.message}`, 'error');
                            assetFileInput.value = '';
                            assetPreview.innerHTML = currentAsset ? `<img src="${currentAsset}" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;">` : '';
                        } finally {
                            hideLoading();
                        }
                    }
                });
                
                document.getElementById('sectionForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const data = {
                        title: document.getElementById('sectionTitle').value.trim(),
                        description: document.getElementById('sectionDescription').value.trim(),
                        route: document.getElementById('sectionRoute').value.trim(),
                        asset: currentAsset,
                        order: parseInt(document.getElementById('sectionOrder').value) || 0,
                        isActive: document.getElementById('sectionIsActive').checked
                    };
                    
                    try {
                        showLoading();
                        if (id) {
                            await librarySectionsAPI.update(id, data);
                            showToast('‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
                        } else {
                            await librarySectionsAPI.create(data);
                            showToast('‚úÖ Th√™m m·ªõi th√†nh c√¥ng!', 'success');
                        }
                        document.getElementById('modal').style.display = 'none';
                        loadData();
                    } catch (error) {
                        showToast(`‚ùå ${error.message}`, 'error');
                    } finally {
                        hideLoading();
                    }
                });
                
                document.getElementById('modal').style.display = 'flex';
            } catch (error) {
                showToast(`‚ùå ${error.message}`, 'error');
            }
        };

        window.deleteItem = async function(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m·ª•c th∆∞ vi·ªán n√†y?')) return;
            
            try {
                await librarySectionsAPI.delete(id);
                showToast('‚úÖ X√≥a th√†nh c√¥ng!', 'success');
                loadData();
            } catch (error) {
                showToast(`‚ùå ${error.message}`, 'error');
            }
        };
    </script>
</body>
</html>

